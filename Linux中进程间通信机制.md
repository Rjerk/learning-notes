# Linux中进程间通信机制

进程间通信（IPC），指两个或多个进程或线程进行数据或信号传输的技术。

## IPC 的分类以及工具

根据功能分成三类：
- 通信：关注进程之间的数据交换
- 同步：关注进程和线程操作之间的同步
- 信号：可以作为一种同步技术，还可以作为一种通信技术。

IPC 工具分类

![](https://github.com/Rjerk/learning-notes/blob/master/img/IPC1.png?raw=true)

### 通信

通信工具分为两类：

1、数据传输工具，区分这些工具的关键因素是写入和读取的概念。
- 字节流：通过管道、FIFO 以及数据报 socket 交换的数据是一个无分隔符的字节流。
- 消息：通过消息队列以及数据报 socket 交换的数据是以分隔符分隔的消息。
- 伪终端：是一种在特殊情况下使用的通信工具。

2、共享内存，它允许进程通过将数据放到由进程间共享的一块内存中以完成信息的交换。由于无需系统调用以及用户内存与内核内存之间的数据传输，因此其通信速度非常快，以弥补需要对共享内存上发生的操作进行同步的不足。放入共享内存的数据对所有共享的进程可见。
Linux 有三种形式的共享内存：System V 共享内存、POSIX 共享内存以及内存映射。

数据传输工具和共享内存的区别在于：
1. 一个数据传输工具可能有多个读者，但读取操作具有破坏性。读取操作会消耗数据，其他进程无法获取所消耗的数据。
2. 读者和写者进程之间的操作是原子性的。如果读者试图从一个不包含数据的数据传输工具中读取数据，那么默认情况下会阻塞至有数据到来。

### 同步

同步可以防止多个进程同时对同一个数据块或同一共享内存之类的操作，以免导致应用程序产生错误的结果。

同步工具有：
- 信号量：一个信号量是由内核维护的整数，其值大于等于0。一个进程可以增加或减少信号量的值，如果试图减少到小于0，内核就会阻塞该操作直到信号量增长到允许该操作执行的程度。Linux 提供了 System V 信号量和 POSIX 信号量。
- 文件锁：设计用来协调操作同一文件的多个进程的动作的一种同步方法，也可以用来协调对其他共享资源的访问。它分为读（共享）锁和写（互斥）锁。任何进程都可以持有同一文件的读锁，但一个进程有了一个文件的写锁后，其他进程将无法获取该文件上的读锁和写锁。Linux 通过 fcntl() 系统调用提供了记录加锁，允许进程在同一文件的不同区域加上多个读锁和写锁。
- 互斥体和条件变量：通常用于 POSIX 线程同步。

执行进程间同步时通常需要根据功能需求来选择工具，当协调对文件的访问时文件记录加锁通常是最佳选择，对于协调对其他共享资源的访问，信号量通常是更佳选择。

### 信号

尽管信号的主要作用不在于此，但在特定场景下可将其作为一种同步技术。因为信号编号本身是一种形式的信息，并可以在实时信号上绑定数据（一个整数或指针），还可以把信号作为一种通信技术来使用。

但由于信号的异步本质需要面对诸如可重入性、竞争条件和正确处理全局变量等问题，而且标准信号无法排队处理，实时信号也有排队数量的限制，信号所携带的信息量更是有限，过低带宽使得信号传输十分缓慢。因此很少将信号用于进程间通信。

信号更为常见的应用场景是用于进程同步，或是其他目的（比如事件通知、作业控制以及定时器到期）。
